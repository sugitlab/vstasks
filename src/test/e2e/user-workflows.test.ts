// Generated by Copilot
// E2E: æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆâ†’ç·¨é›†â†’å®Œäº†ã€è¤‡é›‘ã‚¯ã‚¨ãƒªã€ç¹°ã‚Šè¿”ã—ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import * as assert from "assert";
import * as vscode from "vscode";
import * as fs from "fs";
import * as path from "path";

describe("E2E User Workflows", function () {
  this.timeout(120000);
  const workspaceFolders = vscode.workspace.workspaceFolders;
  const testFolder = workspaceFolders && workspaceFolders[0].uri.fsPath;
  const testFile = testFolder ? path.join(testFolder, "e2e-user.md") : "";

  afterEach(() => {
    if (testFile && fs.existsSync(testFile)) {
      fs.unlinkSync(testFile);
    }
  });

  // åž‹å®šç¾©: E2EWorkflowTask
  interface IE2EWorkflowTask {
    description?: string;
  }

  it("æ–°è¦ã‚¿ã‚¹ã‚¯ä½œæˆâ†’ç·¨é›†â†’å®Œäº†ã®ãƒ•ãƒ­ãƒ¼", async () => {
    if (!testFile) {
      return;
    }
    // æ–°è¦ä½œæˆ
    fs.writeFileSync(testFile, "- [ ] E2E Task 1");
    await vscode.commands.executeCommand(
      "workbench.files.action.refreshFilesExplorer"
    );
    let tasks = await vscode.commands.executeCommand("vstasks.getAllTasks");
    if (!Array.isArray(tasks)) {
      throw new Error("tasks is not an array");
    }
    assert.ok(
      (tasks as IE2EWorkflowTask[]).some((t) => t.description === "E2E Task 1")
    );
    // ç·¨é›†
    fs.writeFileSync(testFile, "- [ ] E2E Task 1 edited");
    await vscode.commands.executeCommand(
      "workbench.files.action.refreshFilesExplorer"
    );
    tasks = await vscode.commands.executeCommand("vstasks.getAllTasks");
    if (!Array.isArray(tasks)) {
      throw new Error("tasks is not an array");
    }
    assert.ok(
      (tasks as IE2EWorkflowTask[]).some(
        (t) => t.description === "E2E Task 1 edited"
      )
    );
    // å®Œäº†
    fs.writeFileSync(testFile, "- [x] E2E Task 1 edited");
    await vscode.commands.executeCommand(
      "workbench.files.action.refreshFilesExplorer"
    );
    tasks = await vscode.commands.executeCommand("vstasks.getAllTasks");
    if (!Array.isArray(tasks)) {
      throw new Error("tasks is not an array");
    }
    assert.ok(
      (tasks as IE2EWorkflowTask[]).some(
        (t) => t.description === "E2E Task 1 edited"
      )
    );
  });

  it("è¤‡é›‘ãªã‚¯ã‚¨ãƒªå®Ÿè¡Œãƒ•ãƒ­ãƒ¼", async () => {
    if (!testFile) {
      return;
    }
    // è¤‡æ•°ã‚¿ã‚¹ã‚¯ä½œæˆ
    fs.writeFileSync(
      testFile,
      "- [ ] Query1 #work\n- [ ] Query2 #home\n- [x] Query3 #work"
    );
    await vscode.commands.executeCommand(
      "workbench.files.action.refreshFilesExplorer"
    );
    // ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
    const result = await vscode.commands.executeCommand(
      "vstasks.runQuery",
      "not done and tag contains #work"
    );
    if (!Array.isArray(result)) {
      throw new Error("result is not an array");
    }
    assert.ok(
      (result as IE2EWorkflowTask[]).some((t) => t.description === "Query1")
    );
    assert.ok(
      !(result as IE2EWorkflowTask[]).some((t) => t.description === "Query3")
    );
  });

  it("ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ã®ç”Ÿæˆãƒ»ç®¡ç†ãƒ•ãƒ­ãƒ¼", async () => {
    if (!testFile) {
      return;
    }
    // ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ä½œæˆ
    fs.writeFileSync(testFile, "- [ ] Repeat Task ðŸ” every day");
    await vscode.commands.executeCommand(
      "workbench.files.action.refreshFilesExplorer"
    );
    let tasks = await vscode.commands.executeCommand("vstasks.getAllTasks");
    if (!Array.isArray(tasks)) {
      throw new Error("tasks is not an array");
    }
    assert.ok(
      (tasks as IE2EWorkflowTask[]).some((t) => t.description === "Repeat Task")
    );
    // å®Œäº†â†’æ¬¡å›žç”Ÿæˆ
    fs.writeFileSync(testFile, "- [x] Repeat Task ðŸ” every day");
    await vscode.commands.executeCommand(
      "workbench.files.action.refreshFilesExplorer"
    );
    tasks = await vscode.commands.executeCommand("vstasks.getAllTasks");
    if (!Array.isArray(tasks)) {
      throw new Error("tasks is not an array");
    }
    // æ–°ã—ã„ç¹°ã‚Šè¿”ã—ã‚¿ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆä¾‹: descriptionãŒRepeat Taskã®ã‚‚ã®ãŒå­˜åœ¨ï¼‰
    assert.ok(
      (tasks as IE2EWorkflowTask[]).some((t) => t.description === "Repeat Task")
    );
  });

  it("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ãƒ­ãƒ¼", async () => {
    if (!testFile) {
      return;
    }
    // ã‚¿ã‚¹ã‚¯ä½œæˆ
    fs.writeFileSync(testFile, "- [ ] Exported Task");
    await vscode.commands.executeCommand(
      "workbench.files.action.refreshFilesExplorer"
    );
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    await vscode.commands.executeCommand("vstasks.exportTasks");
    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    await vscode.commands.executeCommand("vstasks.importTasks");
    // ã‚¿ã‚¹ã‚¯ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
    const tasks = await vscode.commands.executeCommand("vstasks.getAllTasks");
    if (!Array.isArray(tasks)) {
      throw new Error("tasks is not an array");
    }
    assert.ok(
      (tasks as IE2EWorkflowTask[]).some(
        (t) => t.description === "Exported Task"
      )
    );
  });
});
